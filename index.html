<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BTC Party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <!-- Safari / iOS icons (see section 2 for files) -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="BTC Party">
  <meta name="theme-color" content="#000000">

  <style>
    :root { color-scheme: dark; }
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      display: grid;
      place-items: center;
    }
    .stage {
      width: min(92vw, 1200px);
      /* 22:9 frame using modern CSS */
      aspect-ratio: 22 / 9;
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.6);
    }
    video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain; /* keep full video visible */
      background: #000;
    }
    .badge {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: #bbb;
      opacity: .9;
      text-align: center;
      padding: .25rem .5rem;
      border-radius: 999px;
      background: rgba(20,20,20,.6);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
    }
  </style>
</head>
<body>
  <div class="stage">
    <video id="player" controls playsinline></video>
  </div>
  <div class="badge">BTC Party — live</div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script>
    // ---- CONFIG ----
    const RAW_M3U8 =
      "https://prod-fastly-eu-west-1.video.pscp.tv/Transcoding/v1/hls/tz2CDsPMsHb-H_P_98-V8e87QFwfOcyKz-DOiSFYJbsid08YlfrKX4FjFpJp3PeRwGUipiQ8XqDLc3w4Si_-7g/non_transcode/eu-west-1/periscope-replay-direct-prod-eu-west-1-public/master_dynamic_playlist.m3u8?type=live";

    // Your Cloudflare Worker that rewrites playlists & segments:
    const WORKER_BASE = "https://twilight-dust-7cd4.robin-f5c.workers.dev";
    const SRC = `${WORKER_BASE}/?u=${encodeURIComponent(RAW_M3U8)}`;

    const video = document.getElementById("player");

    function boot(url) {
      // required for autoplay on desktop & mobile
      video.muted = true;
      video.autoplay = true;

      if (Hls.isSupported()) {
        const hls = new Hls({ liveDurationInfinity: true });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          const p = video.play();
          if (p && p.catch) p.catch(()=>{ /* wait for user gesture */ });
        });
        // make <source> visible to Safari's "Open in PiP" etc.
        hls.on(Hls.Events.LEVEL_LOADED, (_, data) => {
          if (!video.src) video.src = url;
        });
      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
        // Safari / iOS
        video.src = url;
        video.play().catch(()=>{});
      } else {
        alert("Your browser cannot play HLS.");
      }

      // First user gesture → unmute
      window.addEventListener("click", () => {
        video.muted = false;
        video.play().catch(()=>{});
      }, { once: true });
    }

    boot(SRC);
  </script>
</body>
</html>
